<!DOCTYPE HTML>
<html>
	<head>
		<title>SporSepetim</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="assets/css/main.css" />
		<link rel="icon" type="image/png" href="images/icons/mainicon.png"/>
		<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	</head>
	<body style="margin:0;" class="is-preload">
		<div id="loader"></div>
		<div style="display:none;" class="animate-bottom" id="myDiv">
		<!-- Wrapper -->
			<div id="wrapper">

				<!-- Main -->
					<div id="main">
						<div class="inner">

							<!-- Header -->
								<header id="header">
									<a href="index.html" class="logo"><strong>SporSepetim</strong></a>
									<ul id="userIcon" class="icons">
										<li><input style="height:30px;" type="text" name="query" id="email" placeholder="Email" /></li>
										<li><input style="height:30px;" type="password" name="query" id="password" placeholder="Şifre" /></li>

										<li><a style="font-size:18px" onclick="login1()" class="icon fa-arrow-circle-o-right"></a></li>
										<br><li><a onclick='resetSifre()' style='font-size:10px'>Şifremi Unuttum.</a></li>
										<!--<li><a href="#" class="icon fa-user"><span class="label">Twitter</span></a></li>
										<li><a href="#" class="icon fa-power-off"><span class="label">Facebook</span></a></li>
										<li><a href="#" class="icon fa-enter"><span class="label">Instagram</span></a></li> -->
									</ul>
								</header>

							<!-- Content -->
								<!-- burdan -->
								<div class="container1">
  							<textarea id="myDescriptionTextArea" placeholder="Kendinle ilgili açıklamanı yaz."></textarea>
								<img id="denemeimg" src="images/emptyUser.jpg" alt="profile-sample4" class="profile" style="width:200px;height:200px" />
								<div id="filesubmit">
						      <input type="file" class="file-select" accept="image/*"/>
						      <progress id="uploader" value="0" max="100">0%</progress>
						      <button class="file-submit">Yükle</button>
						    </div>


							</div>

				          <div class="line-separator"></div>
                  <form class="" action="editprofile.html" method="post">
                    <div class="container">



                      <div class="form-item col-2">
                        <h1>Kişisel Bilgiler</h1>
                        <div class="custom-input active">
                          <label>Ad</label>
                            <input id="name" class="validate-item data-hj-whitelist" type="text" />

                        </div>

                        <div class="custom-input active">
                          <label>Soyad</label>
                            <input class="validate-item data-hj-whitelist" id="surname" name="LastName" type="text" />

                        </div>


                    <div class="form-item">
                        <div class="custom-input active">
                          <label>Email</label>
                            <input class="validate-item email data-hj-whitelist" id="email" name="Email" type="text" />

                        </div>
                    </div>
                    <div class="form-item">
                        <div class="custom-input">
                            <label>Doğum Tarihi</label>
														<input id="birthdateID" type="date" name="bday"  />
                        </div>
                    </div>
                    <div class="form-item">
                        <div class="custom-input">
                          <label>Telefon Numarası</label>
                            <input class="phone data-hj-whitelist" id="phone" name="Phone" type="text" value="" />

                        </div>
                    </div>

										<div class="form-item">
                        <div class="custom-input">
                          <label>Statü</label>
                            <input class="phone data-hj-whitelist" id="status" name="statu" type="text" value="" />
                        </div>
                    </div>

										<div class="form-item">
                        <div class="custom-input">
                          <label>Hobiler</label>
                            <input class="phone data-hj-whitelist" id="hobiler" name="hobi" type="text" value="" />
                        </div>
                    </div>

                    </div>

                    </div>

                    <div class="container">
                      <input type="button" value="Kaydet" onclick="saveEditProfile()">
                    </div>

            </form>
								<!-- buraya -->
								<!-- Sidebar -->
									<div id="sidebar">
										<div class="inner">

											<!-- Menu -->
												<nav id="menu">
													<header class="major">
														<h2>Menu</h2>
													</header>
													<ul>
														<li><a href="index.html">Anasayfa</a></li>
														<li><a href="#">Hakkımızda</a></li>
														<li><a href="sportcenters.html">Spor Salonları</a></li>
														<li><a href="trainers.html">Eğitmenler</a></li>
														<li><a href="#">İletişim</a></li>
														<li>
															<span class="opener">Another Submenu</span>
															<ul>
																<li><a href="#">Lorem Dolor</a></li>
																<li><a href="#">Ipsum Adipiscing</a></li>
																<li><a href="#">Tempus Magna</a></li>
																<li><a href="#">Feugiat Veroeros</a></li>
															</ul>
														</li>
													</ul>
												</nav>


												<section>
													<header class="major">
														<h2>İletişim</h2>
													</header>
													<p>
														Herhangi bir konuda şikayet etmek, bilgi almak veya fikirlerinizi bizimle paylaşmak
													için aşağıdaki e-mail ile bize ulaşabilirsiniz.</p>
													<ul class="contact">
														<li class="fa-envelope-o"><a href="#">info@sporsepetim.com</a></li>
														<li class="fa-phone">(212) 567-9822</li>
														<li class="fa-home">1234 Akaretler #8254<br />
														İstanbul, TR 00000-0000</li>
													</ul>
												</section>

											<!-- Footer -->
												<footer id="footer">
													<p class="copyright">&copy; SE302-Team. All rights reserved.</p>
												</footer>

										</div>
									</div>

					</div>

		<!-- Scripts -->
			<script src="assets/js/jquery.min.js"></script>
			<script src="assets/js/browser.min.js"></script>
			<script src="assets/js/breakpoints.min.js"></script>
			<script src="assets/js/util.js"></script>
			<script src="assets/js/main.js"></script>


			<script src="https://www.gstatic.com/firebasejs/5.9.1/firebase.js"></script>
	    <script src="assets/js/db.js"></script>

	  <script>

	firebase.auth().onAuthStateChanged(function(user) {
	if (user) {
	  // User is signed in.
		firebase.database().ref("Users").on("child_added",function(snapshot2){
			firebase.database().ref("Users").child(snapshot2.key).on("child_added", function(snapshot){
				if(snapshot.key == user.uid){
					userNameAsString = snapshot.val().name + " " + snapshot.val().surname + "(" + snapshot.val().status + ")"
					document.getElementById("userIcon").innerHTML = "<li><a onclick='logout1()' class='icon fa-power-off'></a></li><li><a href='editprofile.html' class='icon fa-user'><br>" + userNameAsString + "</a></li>"
				}
			});

		});

		getPopularTrainersImage(user.uid);
		getInfo(user.uid);
		notLoading();


	} else {
	  // No user is signed in.

		window.location.href = "file:///Users/ogedaysunar/Documents/GitHub/SE302-sporsepeti/se302proje/index.html";
	}
	});

	//----------------- LOADING ICON START. -------------------//
	function notLoading() {
		document.getElementById("loader").style.display = "none";
		document.getElementById("myDiv").style.display = "block";
	}

	function showLoading() {
		document.getElementById("loader").style.display = "block";
		document.getElementById("myDiv").style.display = "none";
	}
	//----------------- LOADING ICON FINISH. -------------------//

	function getPopularTrainersImage(uid){
		showLoading(); // RESİM İNDİRME DENEME..
	  var storageRef = firebase.storage().ref();
	  var starsRef = storageRef.child('trainers/' + uid);
	  // Get the download URL
	  starsRef.getDownloadURL().then(function(url) {
	  // Insert url into an <img> tag to "download"
	  if(url.includes(uid)){
	    document.getElementById("denemeimg").src = url;

	  }
		notLoading();
	  }).catch(function(error) {
	  switch (error.code) {
	    case 'storage/object_not_found':
	      // File doesn't exist
	      alert("Üzgünüz. Dosya bulunamıyor.");
	      break;
	    case 'storage/unauthorized':
	      // User doesn't have permission to access the object
	      alert("Bu resmi çekmenize izniniz yok.");
	      break;
	    case 'storage/canceled':
	      // User canceled the upload
	      alert("Beklenmeyen bir hata oluştu. Lütfen daha sonra tekrar deneyiniz.");
	      break;
	    case 'storage/unknown':
	      // Unknown error occurred, inspect the server response
	      alert("Lütfen bizimle iletişime geçiniz");
	      break;
	  }
	});
	}

	// UPLOAD IMAGE -------------------->
	const storageService = firebase.storage();
	const storageRef = storageService.ref();

	document.querySelector('.file-select').addEventListener('change', handleFileUploadChange);
	document.querySelector('.file-submit').addEventListener('click', handleFileUploadSubmit);

	var selectedFile;
	  function handleFileUploadChange(e) {
	    selectedFile = e.target.files[0];
	}

	function handleFileUploadSubmit(e) {
	  var user = firebase.auth().currentUser;
	  var downloadURL = "";
	  console.log(user.uid);
	  const uploadTask = storageRef.child('trainers/' + user.uid).put(selectedFile); //create a child directory called images, and place the file inside this directory
	  uploadTask.on('state_changed', (snapshot) => {
	    var percentage = (snapshot.bytesTransferred/snapshot.totalBytes)*100;
	    uploader.value = percentage;

	  }, (error) => {
	    // Handle unsuccessful uploads
	    console.log(error);
	  }, () => {
	    // Do something once upload is complete
	    //document.getElementById("yuklemeBildirim").innerHTML = "Resminiz eklenmiştir.";
	    console.log('success');
			location.reload();
			e.target.files[0] = "";
	  });
	}
	// UPLOAD IMAGE FINISH  -------------->

	function getInfo(uid){
		firebase.database().ref("Users").on("child_added",function(snapshot){
			firebase.database().ref("Users").child(snapshot.key).on("child_added",function(snapshot2){
				if(snapshot2.key == uid){
					document.getElementById("name").value = snapshot2.val().name
					document.getElementById("surname").value = snapshot2.val().surname
					document.getElementById("email").value = snapshot2.val().email
					document.getElementById("phone").value = snapshot2.val().phone
					document.getElementById("status").value = snapshot2.val().status
					document.getElementById("myDescriptionTextArea").value = snapshot2.val().myDescription
					document.getElementById("birthdateID").value = snapshot2.val().birthdate
					document.getElementById("hobiler").value = snapshot2.val().hobiler
				}
			});
		});
	}

	function logout1(){
	firebase.auth().signOut().then(function() {
		console.log('Signed Out');
	}, function(error) {
		console.error('Sign Out Error', error);
	});
}

function saveEditProfile(){
	var name = document.getElementById("name").value
	var surname = document.getElementById("surname").value
	var email = document.getElementById("email").value
	var phone = document.getElementById("phone").value
	var myDescription = document.getElementById("myDescriptionTextArea").value
	var birthdate = document.getElementById("birthdateID").value
	var hobi = document.getElementById("hobiler").value

	if(validateEmail(email)){
		if(name == ""){
			alert("Lütfen isminizi boş bırakmayınız.");
		}else{
			if(surname == ""){
				alert("Lütfen soyadınızı boş bırakmayınız.");
			}else{
				if(email == ""){
					alert("Lütfen emailinizi boş bırakmayınız.");
				}else{
					if(phone == ""){
						alert("Lütfen telefon kısmını boş bırakmayınız.")
					}else{
						if(myDescription == ""){
							alert("Lütfen açıklama kısmını boş bırakmayınız.");
						}else{
							if(birthdate == ""){
								alert("Lütfen doğum tarihinizi boş bırakmayınız.");
							}else{
								// run codee
								var userID = firebase.auth().currentUser.uid;
								var statu = document.getElementById("status").value;
								firebase.database().ref("Users").child(statu).child(userID).update({
									name: name,
									surname: surname,
									phone: phone,
									email: email,
									myDescription: myDescription,
									birthdate: birthdate,
									hobiler: hobi
								}).then(function(){
  								alert("Bilgileriniz başarılı bir şekilde kaydedildi.");
								}).catch(function(error) {
  								alert("Opss. Bir hata oluştu, lütfen tekrar deneyiniz.");
								});
							}
						}
					}
				}
			}
		}
	}else{
		alert("Lütfen geçerli bir email giriniz.");
	}

}

function validateEmail(email) {
var re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
return re.test(String(email).toLowerCase());
}

	</script>

	</body>
</html>
